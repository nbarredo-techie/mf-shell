<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug React Externalization</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .log { background: white; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffe6e6; border-left: 4px solid #ff0000; }
        .success { background: #e6ffe6; border-left: 4px solid #00aa00; }
        .warning { background: #fff3cd; border-left: 4px solid #ffaa00; }
        pre { overflow-x: auto; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>üîç React Externalization Debug</h1>
    <div id="logs"></div>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.0.0",
        "react-dom": "https://esm.sh/react-dom@19.0.0",
        "react/jsx-runtime": "https://esm.sh/react@19.0.0/jsx-runtime",
        "react/jsx-dev-runtime": "https://esm.sh/react@19.0.0/jsx-dev-runtime",
        "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
        "shared-ui": "./dist/terrabost-shared-ui.js",
        "@mf/shell": "./dist/terraboost-mf-shell.js"
      }
    }
    </script>

    <script type="module">
        const logsDiv = document.getElementById('logs');
        
        function log(message, type = 'log') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<pre>${message}</pre>`;
            logsDiv.appendChild(div);
            console.log(message);
        }

        // Track all network requests
        const originalFetch = window.fetch;
        const networkRequests = [];
        
        window.fetch = function(...args) {
            const url = args[0];
            networkRequests.push(url);
            log(`üì° NETWORK: ${url}`);
            return originalFetch.apply(this, args);
        };

        // Override dynamic imports to track them
        const originalImport = window.__import || ((spec) => import(spec));
        window.__import = function(spec) {
            log(`üì¶ IMPORT: ${spec}`);
            return originalImport(spec);
        };

        try {
            log('üöÄ Starting React externalization debug...', 'success');
            
            // Step 1: Load React directly
            log('\n1Ô∏è‚É£ Loading React from import map...');
            const React = await import('react');
            log(`‚úÖ React loaded: version ${React.version}`);
            log(`   React object keys: ${Object.keys(React).slice(0, 10).join(', ')}...`);
            
            // Step 2: Load ReactDOM
            log('\n2Ô∏è‚É£ Loading ReactDOM from import map...');
            const ReactDOM = await import('react-dom');
            log(`‚úÖ ReactDOM loaded`);
            
            // Step 3: Load JSX Runtime
            log('\n3Ô∏è‚É£ Loading JSX Runtime from import map...');
            const JSXRuntime = await import('react/jsx-runtime');
            log(`‚úÖ JSX Runtime loaded`);
            
            // Step 4: Check bundle contents before loading
            log('\n4Ô∏è‚É£ Checking bundle file contents...');
            
            // Fetch and examine shared-ui bundle
            const sharedUIResponse = await fetch('./dist/terrabost-shared-ui.js');
            const sharedUIContent = await sharedUIResponse.text();
            log(`üìÑ Shared-UI bundle size: ${sharedUIContent.length} chars`);
            log(`üìÑ First 200 chars: ${sharedUIContent.substring(0, 200)}`);
            
            // Check for external imports
            const hasReactExternal = sharedUIContent.includes('from"react"') || sharedUIContent.includes('from "react"');
            const hasJSXExternal = sharedUIContent.includes('from"react/jsx-runtime"') || sharedUIContent.includes('from "react/jsx-runtime"');
            
            log(`üîç Shared-UI externals check:`);
            log(`   - React external: ${hasReactExternal ? '‚úÖ' : '‚ùå'}`);
            log(`   - JSX Runtime external: ${hasJSXExternal ? '‚úÖ' : '‚ùå'}`);
            
            // Step 5: Load shared-ui bundle
            log('\n5Ô∏è‚É£ Loading shared-ui bundle...');
            const sharedUI = await import('./dist/terrabost-shared-ui.js');
            log(`‚úÖ Shared-UI loaded successfully`);
            
            // Step 6: Load mf-shell bundle
            log('\n6Ô∏è‚É£ Loading mf-shell bundle...');
            const mfShell = await import('./dist/terraboost-mf-shell.js');
            log(`‚úÖ MF-Shell loaded successfully`);
            
            // Step 7: Analyze network requests
            log('\n7Ô∏è‚É£ Network Request Analysis:', 'warning');
            const reactRequests = networkRequests.filter(url => 
                typeof url === 'string' && (
                    url.includes('react') || 
                    url.includes('esm.sh') ||
                    url.includes('.js')
                )
            );
            
            log(`üìä Total React-related requests: ${reactRequests.length}`);
            reactRequests.forEach((req, i) => {
                log(`   ${i + 1}. ${req}`);
            });
            
            // Check for duplicates
            const uniqueRequests = [...new Set(reactRequests)];
            if (reactRequests.length !== uniqueRequests.length) {
                log(`‚ùå DUPLICATE REQUESTS DETECTED!`, 'error');
                log(`   Total: ${reactRequests.length}, Unique: ${uniqueRequests.length}`);
            } else {
                log(`‚úÖ No duplicate requests`, 'success');
            }
            
            log('\nüéâ Debug complete!', 'success');
            
        } catch (error) {
            log(`‚ùå ERROR: ${error.message}`, 'error');
            log(`Stack: ${error.stack}`, 'error');
        }
    </script>
</body>
</html>
