<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed Import Map Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 20px; border-radius: 8px; }
        .log { margin: 5px 0; padding: 8px; border-radius: 4px; }
        .error { background: #ffe6e6; border-left: 4px solid #ff0000; }
        .success { background: #e6ffe6; border-left: 4px solid #00aa00; }
        .warning { background: #fff3cd; border-left: 4px solid #ffaa00; }
        .info { background: #e6f3ff; border-left: 4px solid #0066cc; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ†Ô∏è Fixed Import Map Test</h1>
        <p>Testing a simplified import map that should resolve React consistently.</p>
        <div id="logs"></div>
    </div>

    <!-- Simplified Import Map using jsDelivr with consistent URLs -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://cdn.jsdelivr.net/npm/react@19.0.0/+esm",
        "react-dom": "https://cdn.jsdelivr.net/npm/react-dom@19.0.0/+esm",
        "react/jsx-runtime": "https://cdn.jsdelivr.net/npm/react@19.0.0/jsx-runtime.js/+esm",
        "react/jsx-dev-runtime": "https://cdn.jsdelivr.net/npm/react@19.0.0/jsx-dev-runtime.js/+esm",
        "react-dom/client": "https://cdn.jsdelivr.net/npm/react-dom@19.0.0/client.js/+esm",
        "shared-ui": "./dist/terrabost-shared-ui.js",
        "@mf/shell": "./dist/terraboost-mf-shell.js"
      }
    }
    </script>

    <script type="module">
        const logsDiv = document.getElementById('logs');
        const networkRequests = new Set();
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = message;
            logsDiv.appendChild(div);
            console.log(message);
        }

        // Override fetch to track requests
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = args[0];
            if (typeof url === 'string') {
                networkRequests.add(url);
                if (url.includes('react') || url.includes('cdn.jsdelivr')) {
                    log(`üì° Loading: ${url}`);
                }
            }
            return originalFetch.apply(this, args);
        };

        async function runTest() {
            try {
                log('üöÄ Starting simplified import map test...', 'success');
                
                // Load React dependencies
                log('\n1Ô∏è‚É£ Loading React...');
                const React = await import('react');
                log(`‚úÖ React ${React.version} loaded successfully`);
                
                log('\n2Ô∏è‚É£ Loading ReactDOM...');
                const ReactDOM = await import('react-dom');
                log(`‚úÖ ReactDOM loaded successfully`);
                
                log('\n3Ô∏è‚É£ Loading JSX Runtime...');
                const JSXRuntime = await import('react/jsx-runtime');
                log(`‚úÖ JSX Runtime loaded successfully`);
                
                // Test microfrontend bundles
                log('\n4Ô∏è‚É£ Loading Shared-UI bundle...');
                const sharedUI = await import('./dist/terrabost-shared-ui.js');
                log(`‚úÖ Shared-UI bundle loaded successfully`);
                
                log('\n5Ô∏è‚É£ Loading MF-Shell bundle...');
                const mfShell = await import('./dist/terraboost-mf-shell.js');
                log(`‚úÖ MF-Shell bundle loaded successfully`);
                
                // Analyze network requests
                log('\nüìä Network Analysis:', 'warning');
                const requests = Array.from(networkRequests);
                const reactRequests = requests.filter(url => 
                    url.includes('react') || url.includes('cdn.jsdelivr')
                );
                
                log(`Total React-related requests: ${reactRequests.length}`);
                reactRequests.forEach((req, i) => {
                    const shortUrl = req.replace('https://cdn.jsdelivr.net/npm/', '');
                    log(`  ${i + 1}. ${shortUrl}`);
                });
                
                if (reactRequests.length <= 5) {
                    log(`‚úÖ Reasonable number of requests (${reactRequests.length})`, 'success');
                } else {
                    log(`‚ö†Ô∏è Too many requests (${reactRequests.length})`, 'warning');
                }
                
                // Test React instance consistency
                const React2 = await import('react');
                const sameInstance = React === React2;
                log(`\nüîç React instance check: ${sameInstance ? 'CONSISTENT' : 'INCONSISTENT'}`, 
                    sameInstance ? 'success' : 'error');
                
                log('\nüéâ Test completed!', 'success');
                
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
                console.error(error);
            }
        }

        runTest();
    </script>
</body>
</html>
