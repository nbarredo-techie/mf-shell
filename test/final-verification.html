<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úÖ Final React Externalization Verification</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: rgba(255,255,255,0.95); 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            color: #333;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .status-card {
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid;
        }
        .success { background: #d4edda; border-color: #28a745; }
        .error { background: #f8d7da; border-color: #dc3545; }
        .warning { background: #fff3cd; border-color: #ffc107; }
        .info { background: #e2e3e5; border-color: #6c757d; }
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px;
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
        }
        .network-log {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            margin: 15px 0;
        }
        .final-score {
            text-align: center;
            font-size: 2em;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ React Externalization Final Verification</h1>
        <p>Comprehensive test to verify React is properly externalized and no duplicates are loading.</p>
        
        <div class="status-grid">
            <div class="status-card info" id="config-status">
                <h3>üìã Configuration</h3>
                <div id="config-details">Checking...</div>
            </div>
            
            <div class="status-card info" id="externals-status">
                <h3>üîó Externals Status</h3>
                <div id="externals-details">Checking...</div>
            </div>
            
            <div class="status-card info" id="network-status">
                <h3>üåê Network Activity</h3>
                <div id="network-details">Monitoring...</div>
            </div>
            
            <div class="status-card info" id="instance-status">
                <h3>üîç React Instances</h3>
                <div id="instance-details">Verifying...</div>
            </div>
        </div>

        <div class="network-log" id="network-log">
            <strong>Network Request Log:</strong><br>
        </div>

        <div class="final-score" id="final-score">
            üîÑ Running verification...
        </div>
    </div>

    <!-- Optimized Import Map using jsDelivr -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://cdn.jsdelivr.net/npm/react@19.0.0/+esm",
        "react-dom": "https://cdn.jsdelivr.net/npm/react-dom@19.0.0/+esm",
        "react/jsx-runtime": "https://cdn.jsdelivr.net/npm/react@19.0.0/jsx-runtime.js/+esm",
        "react/jsx-dev-runtime": "https://cdn.jsdelivr.net/npm/react@19.0.0/jsx-dev-runtime.js/+esm",
        "react-dom/client": "https://cdn.jsdelivr.net/npm/react-dom@19.0.0/client.js/+esm",        "shared-ui": "../dist/terraboost-shared-ui.js",
        "@mf/shell": "../dist/terraboost-mf-shell.js"
      }
    }
    </script>

    <script type="module">
        const networkRequests = [];
        const startTime = performance.now();
        let score = 0;
        let maxScore = 100;

        function updateCard(cardId, status, content) {
            const card = document.getElementById(cardId);
            card.className = `status-card ${status}`;
            document.getElementById(cardId.replace('-status', '-details')).innerHTML = content;
        }

        function logNetwork(message) {
            document.getElementById('network-log').innerHTML += message + '<br>';
        }

        // Monitor all network requests
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = args[0];
            if (typeof url === 'string') {
                networkRequests.push({ url, timestamp: performance.now() });
                const shortUrl = url.replace(/https:\/\/[^\/]+\//, '');
                logNetwork(`üì° ${shortUrl}`);
            }
            return originalFetch.apply(this, args);
        };

        async function verifyConfiguration() {
            updateCard('config-status', 'info', 'Using jsDelivr CDN for React dependencies...');
            score += 10;
            
            const reactRequests = networkRequests.filter(req => 
                req.url.includes('react') || req.url.includes('cdn.jsdelivr')
            );
            
            updateCard('config-status', 'success', `
                <div class="metric"><span>CDN Provider:</span><span>jsDelivr</span></div>
                <div class="metric"><span>React Version:</span><span>19.0.0</span></div>
                <div class="metric"><span>Import Map:</span><span>‚úÖ Configured</span></div>
            `);
        }

        async function verifyExternals() {
            try {
                // Test React loading
                const React = await import('react');
                const ReactDOM = await import('react-dom');
                const JSXRuntime = await import('react/jsx-runtime');
                
                updateCard('externals-status', 'success', `
                    <div class="metric"><span>React:</span><span>‚úÖ v${React.version}</span></div>
                    <div class="metric"><span>ReactDOM:</span><span>‚úÖ Loaded</span></div>
                    <div class="metric"><span>JSX Runtime:</span><span>‚úÖ Loaded</span></div>
                `);
                score += 30;
                  // Test microfrontend bundles
                const sharedUI = await import('../dist/terraboost-shared-ui.js');
                const mfShell = await import('../dist/terraboost-mf-shell.js');
                
                updateCard('externals-status', 'success', `
                    <div class="metric"><span>React:</span><span>‚úÖ v${React.version}</span></div>
                    <div class="metric"><span>ReactDOM:</span><span>‚úÖ Loaded</span></div>
                    <div class="metric"><span>JSX Runtime:</span><span>‚úÖ Loaded</span></div>
                    <div class="metric"><span>Shared-UI:</span><span>‚úÖ Loaded</span></div>
                    <div class="metric"><span>MF-Shell:</span><span>‚úÖ Loaded</span></div>
                `);
                score += 20;
                
            } catch (error) {
                updateCard('externals-status', 'error', `‚ùå Failed to load: ${error.message}`);
            }
        }

        async function verifyNetwork() {
            // Wait a moment for all requests to complete
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const reactRequests = networkRequests.filter(req => 
                req.url.includes('react') || req.url.includes('cdn.jsdelivr')
            );
            
            const uniqueRequests = [...new Set(reactRequests.map(req => req.url))];
            const duplicateCount = reactRequests.length - uniqueRequests.length;
            
            let networkScore = 0;
            let networkStatus = 'success';
            
            if (duplicateCount === 0) {
                networkScore = 30;
                networkStatus = 'success';
            } else if (duplicateCount <= 2) {
                networkScore = 20;
                networkStatus = 'warning';
            } else {
                networkScore = 0;
                networkStatus = 'error';
            }
            
            score += networkScore;
            
            updateCard('network-status', networkStatus, `
                <div class="metric"><span>Total Requests:</span><span>${reactRequests.length}</span></div>
                <div class="metric"><span>Unique Requests:</span><span>${uniqueRequests.length}</span></div>
                <div class="metric"><span>Duplicates:</span><span>${duplicateCount}</span></div>
                <div class="metric"><span>Efficiency:</span><span>${duplicateCount === 0 ? 'üíØ' : duplicateCount <= 2 ? '‚ö†Ô∏è' : '‚ùå'}</span></div>
            `);
        }

        async function verifyInstances() {
            try {
                const React1 = await import('react');
                const React2 = await import('react');
                const React3 = await import('react');
                
                const allSame = React1 === React2 && React2 === React3;
                
                if (allSame) {
                    score += 10;
                    updateCard('instance-status', 'success', `
                        <div class="metric"><span>Instance 1:</span><span>‚úÖ ${React1.version}</span></div>
                        <div class="metric"><span>Instance 2:</span><span>‚úÖ Same</span></div>
                        <div class="metric"><span>Instance 3:</span><span>‚úÖ Same</span></div>
                        <div class="metric"><span>Consistency:</span><span>üíØ Perfect</span></div>
                    `);
                } else {
                    updateCard('instance-status', 'error', `
                        <div class="metric"><span>Consistency:</span><span>‚ùå Failed</span></div>
                        <div class="metric"><span>Issue:</span><span>Multiple React instances</span></div>
                    `);
                }
            } catch (error) {
                updateCard('instance-status', 'error', `‚ùå Error: ${error.message}`);
            }
        }

        function showFinalScore() {
            const percentage = Math.round((score / maxScore) * 100);
            const finalScoreEl = document.getElementById('final-score');
            
            let status, message, color;
            
            if (percentage >= 90) {
                status = 'üéâ EXCELLENT';
                message = 'React externalization is working perfectly!';
                color = '#28a745';
            } else if (percentage >= 70) {
                status = '‚úÖ GOOD';
                message = 'React externalization is working well with minor issues.';
                color = '#ffc107';
            } else if (percentage >= 50) {
                status = '‚ö†Ô∏è NEEDS IMPROVEMENT';
                message = 'React externalization has some issues that need attention.';
                color = '#fd7e14';
            } else {
                status = '‚ùå CRITICAL';
                message = 'React externalization is not working properly.';
                color = '#dc3545';
            }
            
            finalScoreEl.innerHTML = `
                <div style="color: ${color};">
                    <div style="font-size: 1.5em; margin-bottom: 10px;">${status}</div>
                    <div style="font-size: 1em; margin-bottom: 15px;">${message}</div>
                    <div style="font-size: 2em; font-weight: bold;">${percentage}%</div>
                    <div style="font-size: 0.8em; margin-top: 10px;">Score: ${score}/${maxScore}</div>
                </div>
            `;
            finalScoreEl.style.background = color + '20';
            finalScoreEl.style.border = `2px solid ${color}`;
        }

        async function runVerification() {
            try {
                await verifyConfiguration();
                await verifyExternals();
                await verifyNetwork();
                await verifyInstances();
                showFinalScore();
                
                const totalTime = Math.round(performance.now() - startTime);
                logNetwork(`\n‚úÖ Verification completed in ${totalTime}ms`);
                
            } catch (error) {
                console.error('Verification failed:', error);
                updateCard('final-score', 'error', `‚ùå Verification failed: ${error.message}`);
            }
        }

        runVerification();
    </script>
</body>
</html>
